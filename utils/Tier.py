TIER_THRESHOLDS = {
    "facebook": {
        "mega influencer": {
            "views": {"gold": 400000, "silver": 200000, "bronze": 100000},
            "view_rate": {"gold": 0.025, "silver": 0.012, "bronze": 0.006},
            "engagement": {"gold": 30000, "silver": 12000, "bronze": 6000},
            "engagement_rate": {"gold": 0.002, "silver": 0.001, "bronze": 0.0005},
        },
        "macro influencer": {
            "views": {"gold": 200000, "silver": 100000, "bronze": 40000},
            "view_rate": {"gold": 0.10, "silver": 0.05, "bronze": 0.025},
            "engagement": {"gold": 7000, "silver": 3000, "bronze": 1500},
            "engagement_rate": {"gold": 0.003, "silver": 0.0015, "bronze": 0.0008},
        },
        "upper-tier influencer": {
            "views": {"gold": 80000, "silver": 40000, "bronze": 15000},
            "view_rate": {"gold": 0.22, "silver": 0.12, "bronze": 0.05},
            "engagement": {"gold": 3000, "silver": 1800, "bronze": 1000},
            "engagement_rate": {"gold": 0.01, "silver": 0.005, "bronze": 0.0025},
        },
        "mid-tier influencer": {
            "views": {"gold": 18000, "silver": 8000, "bronze": 4000},
            "view_rate": {"gold": 0.28, "silver": 0.14, "bronze": 0.06},
            "engagement": {"gold": 1000, "silver": 500, "bronze": 200},
            "engagement_rate": {"gold": 0.014, "silver": 0.007, "bronze": 0.003},
        },
        "micro influencer": {
            "views": {"gold": 14000, "silver": 6000, "bronze": 3000},
            "view_rate": {"gold": 0.35, "silver": 0.18, "bronze": 0.08},
            "engagement": {"gold": 600, "silver": 300, "bronze": 120},
            "engagement_rate": {"gold": 0.018, "silver": 0.009, "bronze": 0.0035},
        },
        "nano influencer": {
            "views": {"gold": 3500, "silver": 1800, "bronze": 800},
            "view_rate": {"gold": 0.45, "silver": 0.22, "bronze": 0.10},
            "engagement": {"gold": 250, "silver": 120, "bronze": 60},
            "engagement_rate": {"gold": 0.03, "silver": 0.015, "bronze": 0.007},
        }
    },
    "instagram": {
        "mega influencer": {
            "views": {"gold": 800000, "silver": 400000, "bronze": 200000},
            "view_rate": {"gold": 0.10, "silver": 0.05, "bronze": 0.025},
            "engagement": {"gold": 60000, "silver": 30000, "bronze": 15000},
            "engagement_rate": {"gold": 0.008, "silver": 0.004, "bronze": 0.002},
        },
        "macro influencer": {
            "views": {"gold": 400000, "silver": 200000, "bronze": 100000},
            "view_rate": {"gold": 0.20, "silver": 0.10, "bronze": 0.05},
            "engagement": {"gold": 25000, "silver": 12000, "bronze": 6000},
            "engagement_rate": {"gold": 0.014, "silver": 0.007, "bronze": 0.003},
        },
        "upper-tier influencer": {
            "views": {"gold": 100000, "silver": 50000, "bronze": 25000},
            "view_rate": {"gold": 0.35, "silver": 0.18, "bronze": 0.08},
            "engagement": {"gold": 6000, "silver": 3000, "bronze": 1400},
            "engagement_rate": {"gold": 0.022, "silver": 0.01, "bronze": 0.005},
        },
        "mid-tier influencer": {
            "views": {"gold": 30000, "silver": 15000, "bronze": 7000},
            "view_rate": {"gold": 0.40, "silver": 0.20, "bronze": 0.10},
            "engagement": {"gold": 2200, "silver": 1000, "bronze": 500},
            "engagement_rate": {"gold": 0.03, "silver": 0.014, "bronze": 0.006},
        },
        "micro influencer": {
            "views": {"gold": 16000, "silver": 7000, "bronze": 3500},
            "view_rate": {"gold": 0.50, "silver": 0.25, "bronze": 0.12},
            "engagement": {"gold": 1000, "silver": 450, "bronze": 200},
            "engagement_rate": {"gold": 0.035, "silver": 0.016, "bronze": 0.007},
        },
        "nano influencer": {
            "views": {"gold": 4000, "silver": 1800, "bronze": 800},
            "view_rate": {"gold": 0.80, "silver": 0.40, "bronze": 0.20},
            "engagement": {"gold": 300, "silver": 150, "bronze": 70},
            "engagement_rate": {"gold": 0.06, "silver": 0.03, "bronze": 0.015},
        }
    },
    "youtube": {
        "mega influencer": {
            "views": {"gold": 150000, "silver": 70000, "bronze": 30000},
            "view_rate": {"gold": 0.015, "silver": 0.007, "bronze": 0.003},
            "engagement": {"gold": 8000, "silver": 4000, "bronze": 1500},
            "engagement_rate": {"gold": 0.001, "silver": 0.0005, "bronze": 0.0002},
        },
        "macro influencer": {
            "views": {"gold": 60000, "silver": 25000, "bronze": 12000},
            "view_rate": {"gold": 0.04, "silver": 0.02, "bronze": 0.01},
            "engagement": {"gold": 2500, "silver": 1200, "bronze": 600},
            "engagement_rate": {"gold": 0.002, "silver": 0.001, "bronze": 0.0005},
        },
        "upper-tier influencer": {
            "views": {"gold": 35000, "silver": 16000, "bronze": 8000},
            "view_rate": {"gold": 0.10, "silver": 0.05, "bronze": 0.02},
            "engagement": {"gold": 1500, "silver": 700, "bronze": 350},
            "engagement_rate": {"gold": 0.006, "silver": 0.003, "bronze": 0.0015},
        },
        "mid-tier influencer": {
            "views": {"gold": 12000, "silver": 6000, "bronze": 3000},
            "view_rate": {"gold": 0.18, "silver": 0.08, "bronze": 0.04},
            "engagement": {"gold": 600, "silver": 350, "bronze": 150},
            "engagement_rate": {"gold": 0.008, "silver": 0.005, "bronze": 0.002},
        },
        "micro influencer": {
            "views": {"gold": 8000, "silver": 4000, "bronze": 2000},
            "view_rate": {"gold": 0.30, "silver": 0.15, "bronze": 0.07},
            "engagement": {"gold": 300, "silver": 150, "bronze": 70},
            "engagement_rate": {"gold": 0.01, "silver": 0.005, "bronze": 0.0025},
        },
        "nano influencer": {
            "views": {"gold": 3000, "silver": 1500, "bronze": 700},
            "view_rate": {"gold": 0.50, "silver": 0.25, "bronze": 0.12},
            "engagement": {"gold": 100, "silver": 50, "bronze": 25},
            "engagement_rate": {"gold": 0.014, "silver": 0.007, "bronze": 0.003},
        }
    },
    "x" : {
        "mega influencer": {
            "views":         {"gold": 1000000, "silver": 500000, "bronze": 250000},
            "view_rate":     {"gold": 0.08,   "silver": 0.04,   "bronze": 0.02},     
            "engagement":    {"gold": 5500,   "silver": 2800,   "bronze": 1400},
            "engagement_rate":{"gold": 0.0008,  "silver": 0.0004,  "bronze": 0.0002},       
        },
        "macro influencer": {
            "views":         {"gold": 300000,  "silver": 150000,  "bronze": 70000},
            "view_rate":     {"gold": 0.12,   "silver": 0.06,  "bronze": 0.03},
            "engagement":    {"gold": 2500,   "silver": 1200,   "bronze": 600},
            "engagement_rate":{"gold": 0.0012, "silver": 0.0006,  "bronze": 0.0003},     
        },
        "upper-tier influencer": {
            "views":         {"gold": 40000,  "silver": 20000,  "bronze": 10000},
            "view_rate":     {"gold": 0.14,   "silver": 0.07,   "bronze": 0.03},
            "engagement":    {"gold": 600,    "silver": 300,    "bronze": 150},
            "engagement_rate":{"gold": 0.002, "silver": 0.001,  "bronze": 0.0005},
        },
        "mid-tier influencer": {
            "views":         {"gold": 12000,  "silver": 6000,   "bronze": 3000},
            "view_rate":     {"gold": 0.16,   "silver": 0.08,  "bronze": 0.04},
            "engagement":    {"gold": 250,    "silver": 120,    "bronze": 60},
            "engagement_rate":{"gold": 0.003, "silver": 0.0015,   "bronze": 0.0008},
        },
        "micro influencer": {
            "views":         {"gold": 6000,   "silver": 3000,   "bronze": 1500},
            "view_rate":     {"gold": 0.20,    "silver": 0.10,   "bronze": 0.05},
            "engagement":    {"gold": 180,    "silver": 90,    "bronze": 40},
            "engagement_rate":{"gold": 0.006,  "silver": 0.003,   "bronze": 0.0015},
        },
        "nano influencer": {
            "views":         {"gold": 1200,   "silver": 600,   "bronze": 300},
            "view_rate":     {"gold": 0.24,   "silver": 0.12,    "bronze": 0.06},
            "engagement":    {"gold": 60,     "silver": 30,     "bronze": 15},
            "engagement_rate":{"gold": 0.01,"silver": 0.005, "bronze": 0.0025},
        }
}
}


IDEAL_MONTHLY_POSTS = {
    "facebook": {
        "nano influencer": 60,    # 60–70
        "micro influencer": 75,   # 70–80
        "mid-tier influencer": 85,# 80–90
        "upper-tier influencer": 100,# 90–100
        "macro influencer": 120,  # 110–120
        "mega influencer": 140    # 120–140
    },
    "instagram": {
        "nano influencer": 50,
        "micro influencer": 65,
        "mid-tier influencer": 75,
        "upper-tier influencer": 85,
        "macro influencer": 100,
        "mega influencer": 120
    },
    "x": {
        "nano influencer": 30,
        "micro influencer": 45,
        "mid-tier influencer": 55,
        "upper-tier influencer": 65,
        "macro influencer": 80,
        "mega influencer": 100
    },
    "youtube": {
        "nano influencer": 12,
        "micro influencer": 15,
        "mid-tier influencer": 20,
        "upper-tier influencer": 28,
        "macro influencer": 35,
        "mega influencer": 45
    }
}

def get_tier(value: float, platform: str, follower_group: str, metric: str) -> str:
    """
    Returns the tier (Gold, Silver, Bronze, Needs Effort) for a given value and metric.
    """
    platform = platform.lower()
    follower_group = follower_group.lower()
    metric = metric.lower()

    try:
        thresholds = TIER_THRESHOLDS[platform][follower_group][metric]
    except KeyError:
        return "N/A"

    if value >= thresholds["gold"]:
        return "Gold"
    elif value >= thresholds["silver"]:
        return "Silver"
    elif value >= thresholds["bronze"]:
        return "Bronze"
    else:
        return "Needs Effort"

def get_total_metric_thresholds(platform: str, followers_group: str, metric_key: str):
    platform = platform.lower()
    followers_group = followers_group.lower()

    thresholds_map = TIER_THRESHOLDS.get(platform, {}).get(followers_group, {})
    post_thresholds = thresholds_map.get(metric_key, {})

    if not isinstance(post_thresholds, dict):
        return {}

    # Recursive numeric extraction
    def extract_numeric(val):
        if isinstance(val, (int, float)):
            return float(val)
        if isinstance(val, dict):
            for sub_val in val.values():
                num = extract_numeric(sub_val)
                if num is not None:
                    return num
        return None

    numeric_thresholds = {
        tier_name: (extract_numeric(tier_val) or 0.0)
        for tier_name, tier_val in post_thresholds.items()
    }

    # ✅ Correct ideal posts fetching
    ideal_posts_map = IDEAL_MONTHLY_POSTS.get(platform, {})
    ideal_posts = ideal_posts_map.get(followers_group, 4)

    # Multiply numeric thresholds by ideal posts
    total_thresholds = {k: v * ideal_posts for k, v in numeric_thresholds.items()}
    return total_thresholds


